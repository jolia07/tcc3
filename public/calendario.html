<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalendÃ¡rio</title>
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/scheduler/edge/dhtmlxscheduler.css">
    <script src="https://cdn.dhtmlx.com/scheduler/edge/dhtmlxscheduler.js"></script>
    <link rel="stylesheet" href="calendario.css">
</head>
<body>

    <div id="scheduler"></div>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            scheduler.config.xml_date = "%Y-%m-%d %H:%i";
            scheduler.init("scheduler", new Date(), "month");

            // ðŸ”¹ Buscar matÃ©rias e armazenar em uma variÃ¡vel global
            let materias = [];
            await fetch("http://localhost:5505/materias")
                .then(response => response.json())
                .then(data => materias = data);

            // ðŸ”¹ Buscar aulas jÃ¡ registradas e exibir no calendÃ¡rio
            fetch("http://localhost:5505/aulas")
                .then(response => response.json())
                .then(data => {
                    const events = data.map(aula => ({
                        id: aula.id,
                        text: `${aula.uc} - ${aula.turma}`,
                        start_date: aula.horario,
                        end_date: aula.horario,
                        turma: aula.turma,
                        turno: aula.turno,
                        laboratorio: aula.laboratorio,
                        diasSemana: aula.diasSemana,
                        materia_id: aula.materia_id
                    }));
                    scheduler.parse(events, "json");
                });

            // ðŸ”¹ Criar formulÃ¡rio de ediÃ§Ã£o com todas as informaÃ§Ãµes
            scheduler.config.lightbox.sections = [
                { name: "MatÃ©ria", height: 30, map_to: "materia_id", type: "select", options: materias.map(m => ({ key: m.id, label: m.uc })) },
                { name: "Turma", height: 30, map_to: "turma", type: "textarea" },
                { name: "Turno", height: 30, map_to: "turno", type: "select", options: [
                    { key: "Matutino", label: "Matutino" },
                    { key: "Vespertino", label: "Vespertino" },
                    { key: "Noturno", label: "Noturno" }
                ]},
                { name: "LaboratÃ³rio", height: 30, map_to: "laboratorio", type: "textarea" },
                { name: "Dias da Semana", height: 30, map_to: "diasSemana", type: "textarea" },
                { name: "HorÃ¡rio", height: 30, map_to: "start_date", type: "time" },
                { name: "End", height: 30, map_to: "end_date", type: "time" },
                { name: "description", height: 200, map_to: "text", type: "textarea" },
                { name: "time", height: 72, type: "time", map_to: "auto" }
            ];

            // ðŸ”¹ Salvar aula no banco de dados ao adicionar um evento
            scheduler.attachEvent("onEventAdded", function (id, ev) {
                fetch("http://localhost:5505/aulas", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(ev)
                })
                .then(response => response.json())
                .then(data => scheduler.changeEventId(id, data.id));
            });

            // ðŸ”¹ Atualizar aula ao editar um evento
            scheduler.attachEvent("onEventChanged", function (id, ev) {
                fetch(`http://localhost:5505/aulas/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(ev)
                });
            });

            // ðŸ”¹ Deletar aula ao excluir um evento
            scheduler.attachEvent("onEventDeleted", function (id) {
                fetch(`http://localhost:5505/aulas/${id}`, { method: "DELETE" });
            });
        });
    </script>    
    
</body>
</html>